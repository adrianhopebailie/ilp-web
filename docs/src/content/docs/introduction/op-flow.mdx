---
title: Open Payments flow
---

import { MermaidWrapper, Mermaid } from '@interledger/docs-design-system'

This page describes the Open Payments flow at a high level. The sequence diagrams are for illustrative purposes and are not an exact representation of the flow.

## Basic flow

In this flow, assume the client's end-user is the payer and that the client already has the payer's OP-enabled account details (e.g, wallet address).

1. The client, acting on behalf of the end-user, retrieves public information about the payee’s OP-enabled account by making a call to the payee's wallet address. The client receives an authorization server URL to use when requesting grants.

<MermaidWrapper client:load>

<Mermaid
  graph={`sequenceDiagram
    participant C as Client
    participant PAW as Payee's wallet address

    C->>PAW: GET wallet address
    PAW->>C: 200 Wallet address found, returns public info incl. auth server

`}
/>

</MermaidWrapper>

2. The client requests/receives a grant from the payee's authorization server to create an `incoming-payment` resource on the payee’s account. The client then sends a request to the resource server to create the resource. When created, the resource server returns unique payment details the client will use to address one or more payments to the payee.

<MermaidWrapper client:load>

<Mermaid
  graph={`sequenceDiagram
    participant C as Client
    participant AS as Authorization server
    participant RS as Resource server

    C->>AS: Grant request (POST) with type=incoming-payment
    AS->>C: 200 OK, returns access token
    C->>RS: Create incoming payment resource (POST)
    RS->>C: 201 Incoming payment created

`}
/>

</MermaidWrapper>

3. The client requests/receives a grant from the end-user's authorization server to create a `quote` resource on the user's account. The client then sends a request to the user's resource server to create the resource. When created, the resource server returns, among other things, a quote `id` and the amount it will cost to make the payment.

<MermaidWrapper client:load>

<Mermaid
  graph={`sequenceDiagram
    participant C as Client
    participant AS as Authorization server
    participant RS as Resource server

    C->>AS: Grant request (POST) with type=quote
    AS->>C: 200 OK, returns access token
    C->>RS: Create quote resource (POST)
    RS->>C: 201 Quote created

`}
/>

</MermaidWrapper>

4. The client issues an [interactive grant request](/introduction/grants/#outgoing-payment-grant) to the end-user's authorization server to obtain the user's explicit consent to send a payment of X amount. While the client must facilitate the interaction, the authorization server is responsible for the interface and collecting consent.

<MermaidWrapper client:load>

<Mermaid
  graph={`sequenceDiagram
    participant C as Client
    participant AS as Authorization server

    C->>AS: Grant request (POST) with type=outgoing-payment, interact object
    AS->>C: 200 OK, returns interaction instructions
    C->>AS: Sends end-user to redirect URI to initiate interaction flow

`}
/>

</MermaidWrapper>

5. After consent is obtained, the client requests/receives permission to continue the grant request and create an `outgoing-payment` resource on the end-user's payment account. When created, the setup of the payment is complete and the Open Payments flow ends.

<MermaidWrapper client:load>

<Mermaid
  graph={`sequenceDiagram

    participant C as Client
    participant AS as Authorization server

    AS->>AS: End-user interacts with authorization server and approves the grant
    AS->>C: Redirects end-user to client's finish URI, includes hash and interaction reference
    C->>C: Verifies hash
    C->>AS: Grant continuation request (POST) with interaction reference
    AS->>C: 200 Success with access_token

`}
/>

</MermaidWrapper>

## Complex flow

<MermaidWrapper client:load>

<Mermaid
  graph={`sequenceDiagram
    participant Cu as Customer
    participant A2 as Auth Server B
    participant R2 as Backend B
    participant R1 as Backend A
    participant A1 as Auth Server A
    participant Cl as Merchant

    activate Cl
    Cl->>+A1: incoming payment grant request
    A1->>-Cl: grant + access token
    Cl->>+R1: incoming payment creation request
    R1->>+A1: token introspection
    A1->>-R1: token valid + grant details
    R1->>-Cl: incoming payment
    rect rgba(0, 0, 255, .1)
    Cl->>+Cu: request wallet address
    Cu->>Cl: wallet address
    end
    Cl->>+R2: query customer's wallet address
    R2->>-Cl: wallet address details including auth server endpoint
    Cl->>+A2: quote grant request
    A2->>-Cl: grant + access token
    Cl->>+R2: quote creation request
    R2->>+A2: token introspection
    A2->>-R2: token valid + grant details
    R2->>-Cl: quote
    Cl->>+A2: outgoing payment grant request
    A2->>-Cl: IdP redirect info
    rect rgba(0, 0, 255, .1)
    Cl->>Cu: redirect to IdP
    Cu->>Cu: consent to grant request
    Cu->>-Cl: interaction finished
    end
    Cl->>+A2: continue grant request
    A2->>-Cl: grant + access token
    Cl->>+R2: outgoing payment creation request
    R2->>+A2: token introspection
    A2->>-R2: token valid + grant details
    R2->>R2: grant accounting
    R2->>-Cl: outgoing payment
    deactivate Cl

`}
/>

</MermaidWrapper>
